{"version":3,"sources":["../scripts/auth.js"],"names":["window","hermesApp","Auth","_waitForAuthPromiseResolver","promise","database","firebase","auth","$","Deferred","document","ready","signedInUserContainer","signedInUserAvatar","signedInUsername","signOutButton","deleteAccountButton","usernameLink","updateAll","click","signOut","deleteAccount","updateAllAccounts","onAuthStateChanged","user","router","reloadPage","resolve","body","classList","remove","userId","css","firebaseUi","start","uiConfig","add","uid","photoURL","text","displayName","attr","saveUserData","currentUser","delete","then","alert","catch","error","code","updateAllProfiles","functions","httpsCallable","console","message"],"mappings":"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","file":"auth.js","sourcesContent":["'use strict';\n\nwindow.hermesApp = window.hermesApp || {};\n\n/**\n * Handles the user auth flows and updating the UI depending on the auth state.\n */\nhermesApp.Auth = class {\n\n  /**\n   * Returns a Promise that completes when auth is ready.\n   * @return Promise\n   */\n  get waitForAuth() {\n    return this._waitForAuthPromiseResolver.promise();\n  }\n\n  /**\n   * Initializes Friendly Pix's auth.\n   * Binds the auth related UI components and handles the auth flow.\n   * @constructor\n   */\n  constructor() {\n    // Firebase SDK\n    this.database = firebase.database();\n    this.auth = firebase.auth();\n    this._waitForAuthPromiseResolver = new $.Deferred();\n\n    $(document).ready(() => {\n      // Pointers to DOM Elements\n      const signedInUserContainer = $('.hm-signed-in-user-container');\n      this.signedInUserAvatar = $('.hm-avatar', signedInUserContainer);\n      this.signedInUsername = $('.hm-username', signedInUserContainer);\n      this.signOutButton = $('.hm-sign-out');\n      this.deleteAccountButton = $('.hm-delete-account');\n      this.usernameLink = $('.hm-usernamelink');\n      this.updateAll = $('.hm-update-all');\n\n      // Event bindings\n      this.signOutButton.click(() => this.auth.signOut());\n      this.deleteAccountButton.click(() => this.deleteAccount());\n      this.updateAll.click(() => this.updateAllAccounts());\n    });\n\n    this.auth.onAuthStateChanged(user => this.onAuthStateChanged(user));\n  }\n\n  /**\n   * Displays the signed-in user information in the UI or hides it and displays the\n   * \"Sign-In\" button if the user isn't signed-in.\n   */\n  onAuthStateChanged(user) {\n    if (window.hermesApp.router) {\n      window.hermesApp.router.reloadPage();\n    }\n    this._waitForAuthPromiseResolver.resolve();\n    $(document).ready(() => {\n      document.body.classList.remove('hm-auth-state-unknown');\n      if (!user) {\n        this.userId = null;\n        this.signedInUserAvatar.css('background-image', '');\n        firebaseUi.start('#firebaseui-auth-container', uiConfig);\n        document.body.classList.remove('hm-signed-in');\n        document.body.classList.add('hm-signed-out');\n      } else {\n        document.body.classList.remove('hm-signed-out');\n        document.body.classList.add('hm-signed-in');\n        this.userId = user.uid;\n        this.signedInUserAvatar.css('background-image',\n            `url(\"${user.photoURL || '/images/silhouette.jpg'}\")`);\n        this.signedInUsername.text(user.displayName || 'Anonymous');\n        this.usernameLink.attr('href', `/user/${user.uid}`);\n        hermesApp.firebase.saveUserData(user.photoURL, user.displayName);\n      }\n    });\n  }\n\n  deleteAccount() {\n    this.auth.currentUser.delete().then(() => {\n      window.alert('Account deleted');\n    }).catch(error => {\n      if (error.code === 'auth/requires-recent-login') {\n        window.alert(\n          'You need to have recently signed-in to delete your account.\\n' +\n            'Please sign-in and try again.');\n        this.auth.signOut();\n      }\n    });\n  }\n\n  updateAllAccounts() {\n    const updateAllProfiles = firebase.functions().httpsCallable('updateAllProfiles');\n    updateAllProfiles().then(() => {\n      window.alert('Profiles update Finished successfully.');\n    }).catch(error => {\n      console.error('Error updating user profiles.', error);\n      window.alert('Error updating user profiles: ' + error.message);\n    });\n  }\n};\n\nhermesApp.auth = new hermesApp.Auth();\n"]}