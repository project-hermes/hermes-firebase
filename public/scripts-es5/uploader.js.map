{"version":3,"sources":["../scripts/uploader.js"],"names":["window","hermesApp","Uploader","maxDimension","quality","database","firebase","auth","storage","addPolyfills","$","document","ready","addButton","addButtonFloating","imageInput","overlay","newPictureContainer","uploadButton","imageCaptionInput","uploadPicForm","toast","click","initiatePictureCapture","change","readPicture","e","submit","uploadPic","keyup","prop","val","HTMLCanvasElement","prototype","toBlob","Object","defineProperty","value","callback","type","binStr","atob","toDataURL","split","len","length","arr","Uint8Array","i","charCodeAt","Blob","trigger","url","attr","page","focus","disabled","toggle","event","clear","file","target","files","currentFile","wrap","closest","get","reset","unwrap","match","reader","FileReader","onload","displayPicture","result","readAsDataURL","disableUploadUi","fullDeferred","Deferred","thumbDeferred","resolveFullBlob","resolve","blob","resolveThumbBlob","image","Image","src","maxThumbDimension","THUMB_IMAGE_SPECS","thumbCanvas","_getScaledCanvas","maxFullDimension","FULL_IMAGE_SPECS","fullCanvas","Promise","all","promise","then","full","results","thumb","preventDefault","imageCaption","generateImages","uploadNewPic","pics","name","currentUser","uid","data","message","actionHandler","postId","actionText","timeout","MaterialSnackbar","showSnackbar","console","error","cancelAllSubscriptions","MaterialUtils","clearTextField","createElement","width","height","getContext","drawImage","uploader"],"mappings":"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","file":"uploader.js","sourcesContent":["'use strict';\n\nwindow.hermesApp = window.hermesApp || {};\n\n/**\n * Handles uploads of new pics.\n */\nhermesApp.Uploader = class {\n\n  /**\n   * @return {number}\n   */\n  static get FULL_IMAGE_SPECS() {\n    return {\n      maxDimension: 1280,\n      quality: 0.9\n    };\n  }\n\n  /**\n   * @return {number}\n   */\n  static get THUMB_IMAGE_SPECS() {\n    return {\n      maxDimension: 640,\n      quality: 0.7\n    };\n  }\n\n  /**\n   * Inititializes the pics uploader/post creator.\n   * @constructor\n   */\n  constructor() {\n    // Firebase SDK\n    this.database = firebase.database();\n    this.auth = firebase.auth();\n    this.storage = firebase.storage();\n\n    this.addPolyfills();\n\n    $(document).ready(() => {\n      // DOM Elements\n      this.addButton = $('#add');\n      this.addButtonFloating = $('#add-floating');\n      this.imageInput = $('#hm-mediacapture');\n      this.overlay = $('.hm-overlay', '#page-add');\n      this.newPictureContainer = $('#newPictureContainer');\n      this.uploadButton = $('.hm-upload');\n      this.imageCaptionInput = $('#imageCaptionInput');\n      this.uploadPicForm = $('#uploadPicForm');\n      this.toast = $('.mdl-js-snackbar');\n\n      // Event bindings\n      this.addButton.click(() => this.initiatePictureCapture());\n      this.addButtonFloating.click(() => this.initiatePictureCapture());\n      this.imageInput.change(e => this.readPicture(e));\n      this.uploadPicForm.submit(e => this.uploadPic(e));\n      this.imageCaptionInput.keyup(() => this.uploadButton.prop('disabled', !this.imageCaptionInput.val()));\n    });\n  }\n\n  // Adds polyfills required for the Uploader.\n  addPolyfills() {\n    // Polyfill for canvas.toBlob().\n    if (!HTMLCanvasElement.prototype.toBlob) {\n      Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {\n        value: function(callback, type, quality) {\n          var binStr = atob(this.toDataURL(type, quality).split(',')[1]);\n          var len = binStr.length;\n          var arr = new Uint8Array(len);\n\n          for (var i = 0; i < len; i++) {\n            arr[i] = binStr.charCodeAt(i);\n          }\n\n          callback(new Blob([arr], {type: type || 'image/png'}));\n        }\n      });\n    }\n  }\n\n  /**\n   * Start taking a picture.\n   */\n  initiatePictureCapture() {\n    this.imageInput.trigger('click');\n  }\n\n  /**\n   * Displays the given pic in the New Pic Upload dialog.\n   */\n  displayPicture(url) {\n    this.newPictureContainer.attr('src', url);\n    page('/add');\n    this.imageCaptionInput.focus();\n    this.uploadButton.prop('disabled', true);\n  }\n\n  /**\n   * Enables or disables the UI. Typically while the image is uploading.\n   */\n  disableUploadUi(disabled) {\n    this.uploadButton.prop('disabled', disabled);\n    this.addButton.prop('disabled', disabled);\n    this.addButtonFloating.prop('disabled', disabled);\n    this.imageCaptionInput.prop('disabled', disabled);\n    this.overlay.toggle(disabled);\n  }\n\n  /**\n   * Reads the picture the has been selected by the file picker.\n   */\n  readPicture(event) {\n    this.clear();\n\n    var file = event.target.files[0]; // FileList object\n    this.currentFile = file;\n\n    // Clear the selection in the file picker input.\n    this.imageInput.wrap('<form>').closest('form').get(0).reset();\n    this.imageInput.unwrap();\n\n    // Only process image files.\n    if (file.type.match('image.*')) {\n      var reader = new FileReader();\n      reader.onload = e => this.displayPicture(e.target.result);\n      // Read in the image file as a data URL.\n      reader.readAsDataURL(file);\n      this.disableUploadUi(false);\n    }\n  }\n\n  /**\n   * Returns a Canvas containing the given image scaled down to the given max dimension.\n   * @private\n   * @static\n   */\n  static _getScaledCanvas(image, maxDimension) {\n    const thumbCanvas = document.createElement('canvas');\n    if (image.width > maxDimension ||\n      image.height > maxDimension) {\n      if (image.width > image.height) {\n        thumbCanvas.width = maxDimension;\n        thumbCanvas.height = maxDimension * image.height / image.width;\n      } else {\n        thumbCanvas.width = maxDimension * image.width / image.height;\n        thumbCanvas.height = maxDimension;\n      }\n    } else {\n      thumbCanvas.width = image.width;\n      thumbCanvas.height = image.height;\n    }\n    thumbCanvas.getContext('2d').drawImage(image, 0, 0, image.width, image.height,\n      0, 0, thumbCanvas.width, thumbCanvas.height);\n    return thumbCanvas;\n  }\n\n  /**\n   * Generates the full size image and image thumb using canvas and returns them in a promise.\n   */\n  generateImages() {\n    const fullDeferred = new $.Deferred();\n    const thumbDeferred = new $.Deferred();\n\n    const resolveFullBlob = blob => fullDeferred.resolve(blob);\n    const resolveThumbBlob = blob => thumbDeferred.resolve(blob);\n\n    const displayPicture = url => {\n      const image = new Image();\n      image.src = url;\n\n      // Generate thumb.\n      const maxThumbDimension = hermesApp.Uploader.THUMB_IMAGE_SPECS.maxDimension;\n      const thumbCanvas = hermesApp.Uploader._getScaledCanvas(image, maxThumbDimension);\n      thumbCanvas.toBlob(resolveThumbBlob, 'image/jpeg', hermesApp.Uploader.THUMB_IMAGE_SPECS.quality);\n\n      // Generate full sized image.\n      const maxFullDimension = hermesApp.Uploader.FULL_IMAGE_SPECS.maxDimension;\n      const fullCanvas = hermesApp.Uploader._getScaledCanvas(image, maxFullDimension);\n      fullCanvas.toBlob(resolveFullBlob, 'image/jpeg', hermesApp.Uploader.FULL_IMAGE_SPECS.quality);\n    };\n\n    const reader = new FileReader();\n    reader.onload = e => displayPicture(e.target.result);\n    reader.readAsDataURL(this.currentFile);\n\n    return Promise.all([fullDeferred.promise(), thumbDeferred.promise()]).then(results => {\n      return {\n        full: results[0],\n        thumb: results[1]\n      };\n    });\n  }\n\n  /**\n   * Uploads the pic to Cloud Storage and add a new post into the Firebase Database.\n   */\n  uploadPic(e) {\n    e.preventDefault();\n    this.disableUploadUi(true);\n    var imageCaption = this.imageCaptionInput.val();\n\n    this.generateImages().then(pics => {\n      // Upload the File upload to Cloud Storage and create new post.\n      hermesApp.firebase.uploadNewPic(pics.full, pics.thumb, this.currentFile.name, imageCaption)\n          .then(postId => {\n            page(`/user/${this.auth.currentUser.uid}`);\n            var data = {\n              message: 'New pic has been posted!',\n              actionHandler: () => page(`/post/${postId}`),\n              actionText: 'View',\n              timeout: 10000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          }, error => {\n            console.error(error);\n            var data = {\n              message: `There was an error while posting your pic. Sorry!`,\n              timeout: 5000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          });\n        });\n  }\n\n  /**\n   * Clear the uploader.\n   */\n  clear() {\n    this.currentFile = null;\n\n    // Cancel all Firebase listeners.\n    hermesApp.firebase.cancelAllSubscriptions();\n\n    // Clear previously displayed pic.\n    this.newPictureContainer.attr('src', '');\n\n    // Clear the text field.\n    hermesApp.MaterialUtils.clearTextField(this.imageCaptionInput[0]);\n\n    // Make sure UI is not disabled.\n    this.disableUploadUi(false);\n  }\n};\n\nhermesApp.uploader = new hermesApp.Uploader();\n"]}